<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project Tracker</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
:root {
  --bg: #f4f7fa;
  --text: #222;
  --primary: #2563eb;
  --card: #fff;
  --shadow: 0 4px 16px rgba(40,70,120,0.09);
  --border: #e3e6ee;
  --radius: 14px;
}
[data-theme="dark"] {
  --bg: #1a1d23;
  --text: #e7eaf1;
  --card: #23272f;
  --border: #343842;
  --shadow: 0 4px 24px rgba(30,40,60,0.24);
}
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background .25s, color .25s;
}
header {
  background: var(--primary);
  color: #fff;
  padding: 20px 0;
  box-shadow: var(--shadow);
}
.header-inner {
  max-width: 900px;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.header-inner h1 {
  font-size: 1.8em;
  margin: 0;
  letter-spacing: 1px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
}
.header-buttons {
  display: flex;
  gap: 10px;
}
.btn {
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: var(--radius);
  padding: 10px 18px;
  cursor: pointer;
  font-size: 1em;
  font-weight: 500;
  box-shadow: var(--shadow);
  transition: background .2s, transform .1s;
  display: flex;
  align-items: center;
  gap: 6px;
}
.btn:hover { background: #1740a5; transform: translateY(-1px);}
.btn.secondary { background: #fff; color: var(--primary); border: 1px solid var(--border);}
.btn.secondary:hover { background: #f0f2fa; }
.container {
  max-width: 900px;
  margin: 36px auto;
  padding: 0 16px;
}
.dashboard {
  display: flex;
  gap: 18px;
  margin-bottom: 30px;
  flex-wrap: wrap;
}
.dashboard-card {
  flex: 1 1 160px;
  min-width: 180px;
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px;
  border: 1px solid var(--border);
  text-align: center;
}
.dashboard-card h3 {
  margin-top: 0;
  margin-bottom: 8px;
  font-size: 1.05em;
  font-weight: 600;
  letter-spacing: 0.5px;
  color: var(--primary);
}
.dashboard-card .num {
  font-size: 2.4em;
  font-weight: 700;
  letter-spacing: 1px;
  margin: 0;
}
#projects {
  margin-top: 8px;
  display: grid;
  gap: 22px;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}
.project-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 22px 18px 14px 18px;
  border: 1px solid var(--border);
  position: relative;
  display: flex;
  flex-direction: column;
}
.project-card h4 {
  margin: 0 0 3px 0;
  font-weight: 600;
}
.project-actions {
  position: absolute;
  right: 10px;
  top: 12px;
  display: flex;
  gap: 5px;
}
.progress-bar-bg {
  width: 100%;
  height: 7px;
  border-radius: 7px;
  background: #e3e6ee;
  margin: 10px 0 5px 0;
  overflow: hidden;
}
.progress-bar {
  height: 100%;
  background: linear-gradient(90deg,#6c8dfb,#63e7d3 70%);
  transition: width .3s;
}
.task-list {
  margin: 12px 0 0 0;
  padding: 0;
  list-style: none;
  max-height: 140px;
  overflow-y: auto;
}
.task-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
}
.task-item:last-child { border-bottom: none; }
.task-title { flex: 1; }
.task.done .task-title {
  text-decoration: line-through;
  color: #888;
  opacity: 0.8;
}
.task-priority {
  font-size: 0.85em;
  border-radius: 8px;
  padding: 2px 7px;
  font-weight: 500;
  margin-right: 6px;
  background: #eee;
}
.priority-low { color: #1aab00; background: #ecfbe8;}
.priority-medium { color: #a87e02; background: #fdf7e2;}
.priority-high { color: #d61e0c; background: #fbe8e8;}
.add-task-row {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}
.add-task-row input, .add-task-row select, .add-task-row input[type="date"] {
  padding: 7px 10px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  font-size: 1em;
  background: var(--card);
  color: var(--text);
}
.add-task-row input[type="date"] { min-width:120px; }
.add-task-row .btn { padding: 7px 14px; }
.search {
  border-radius: 9px;
  border: 1px solid var(--border);
  padding: 8px 12px;
  font-size: 1em;
  background: var(--card);
  color: var(--text);
}
#projectModal, #taskEditModal {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.18);
  justify-content: center;
  align-items: center;
  z-index: 99;
}
#projectModal .modal-content, #taskEditModal .modal-content {
  background: var(--card);
  padding: 28px 30px 22px;
  border-radius: var(--radius);
  min-width: 320px;
  max-width: 98vw;
  position: relative;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  animation: fadeIn .25s;
}
#projectModal .close-btn, #taskEditModal .close-btn {
  position: absolute;
  top: 10px; right: 16px;
  background: none;
  border: none;
  font-size: 1.3em;
  color: #888;
  cursor: pointer;
  transition: color .15s;
}
#projectModal .close-btn:hover, #taskEditModal .close-btn:hover { color: #c30; }
#projectModal input, #projectModal textarea, #taskEditModal input, #taskEditModal select {
  width: 100%;
  padding: 9px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  font-size: 1em;
  margin-bottom: 18px;
  background: var(--card);
  color: var(--text);
}
@keyframes fadeIn { from {opacity:0;transform:scale(0.97);} to {opacity:1;transform:scale(1);} }
@media (max-width: 700px) {
  .dashboard { flex-direction: column; }
  .container { padding: 0 5px; }
}
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <h1><span class="material-icons" style="font-size:1.2em;">fact_check</span> Project Tracker</h1>
    <div class="header-buttons">
      <button id="themeBtn" class="btn secondary" title="Toggle dark mode"><span class="material-icons">brightness_4</span></button>
      <button id="loginBtn" class="btn secondary">Login</button>
      <button id="logoutBtn" class="btn secondary" style="display:none">Logout</button>
      <button id="newProjectBtn" class="btn"><span class="material-icons">add</span> New Project</button>
      <button id="exportBtn" class="btn secondary"><span class="material-icons">download</span> Export</button>
      <button id="importBtn" class="btn secondary"><span class="material-icons">upload</span> Import</button>
      <input type="file" id="fileInput" style="display:none;">
    </div>
  </div>
</header>
<div class="container">
  <div class="dashboard">
    <div class="dashboard-card">
      <h3>Projects</h3>
      <div class="num" id="projectCount">0</div>
    </div>
    <div class="dashboard-card">
      <h3>Tasks</h3>
      <div class="num" id="taskCount">0</div>
    </div>
    <div class="dashboard-card">
      <h3>Completed</h3>
      <div class="num" id="taskDoneCount">0</div>
    </div>
    <div class="dashboard-card">
      <h3>Progress</h3>
      <div class="num" id="progressPercent">0%</div>
    </div>
  </div>
  <div style="display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap;">
    <input id="searchInput" class="search" type="text" placeholder="Search projects..." style="flex:1;min-width:200px;">
    <select id="sortProjects" class="search" style="min-width:150px;">
      <option value="default">Sort: Default</option>
      <option value="alpha">Sort: A-Z</option>
      <option value="tasks">Sort: By #Tasks</option>
    </select>
  </div>
  <div id="projects"></div>
</div>
<!-- Project Modal -->
<div id="projectModal">
  <div class="modal-content">
    <button class="close-btn" id="closeProjectModal" title="Cancel"><span class="material-icons">close</span></button>
    <h3 id="modalTitle" style="margin-top:0;">New Project</h3>
    <input type="text" id="projectName" placeholder="Project name">
    <textarea id="projectDescription" placeholder="Project description"></textarea>
    <button id="saveProjectBtn" class="btn" style="width:100%;">Save Project</button>
  </div>
</div>
<!-- Task Edit Modal -->
<div id="taskEditModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:200;background:rgba(0,0,0,0.13);align-items:center;justify-content:center;">
  <div class="modal-content" style="min-width:320px;">
    <button class="close-btn" id="closeTaskEditModal" title="Cancel"><span class="material-icons">close</span></button>
    <h3>Edit Task</h3>
    <input type="text" id="editTaskName" placeholder="Task name">
    <input type="date" id="editTaskDueDate">
    <select id="editTaskPriority">
      <option value="low">Low priority</option>
      <option value="medium">Medium priority</option>
      <option value="high">High priority</option>
    </select>
    <button id="saveTaskEditBtn" class="btn" style="width:100%;">Save Task</button>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
let currentUser = localStorage.getItem("user") || null;
let editingProjectIndex = null;
let editingTask = { pidx: null, tidx: null };

function userKey(key) {
  return currentUser ? currentUser + "_" + key : key;
}

function percent(x, y) {
  return y === 0 ? 0 : Math.round((x / y) * 100);
}

// ---- UI State ----
function setAuthUI(loggedIn) {
  document.getElementById("loginBtn").style.display = loggedIn ? "none" : "";
  document.getElementById("logoutBtn").style.display = loggedIn ? "" : "none";
  document.getElementById("newProjectBtn").disabled = !loggedIn;
  document.getElementById("exportBtn").disabled = !loggedIn;
  document.getElementById("importBtn").disabled = !loggedIn;
  document.getElementById("searchInput").disabled = !loggedIn;
  document.getElementById("sortProjects").disabled = !loggedIn;
}

// ---- Dashboard/Analytics ----
function renderDashboard(projects) {
  let tasks = 0, done = 0;
  projects.forEach(p => {
    if (Array.isArray(p.tasks)) {
      tasks += p.tasks.length;
      done += p.tasks.filter(t => t.done).length;
    }
  });
  document.getElementById("projectCount").textContent = projects.length;
  document.getElementById("taskCount").textContent = tasks;
  document.getElementById("taskDoneCount").textContent = done;
  document.getElementById("progressPercent").textContent = percent(done, tasks) + "%";
}

function filterAndSort(projects) {
  let term = document.getElementById("searchInput").value.trim().toLowerCase();
  let mode = document.getElementById("sortProjects").value;
  let filtered = projects.filter(p => p.name.toLowerCase().includes(term));
  if (mode === "alpha") {
    filtered.sort((a, b) => a.name.localeCompare(b.name));
  } else if (mode === "tasks") {
    filtered.sort((a, b) => (b.tasks?.length||0) - (a.tasks?.length||0));
  }
  return filtered;
}

// ---- Project Render ----
function renderProjects() {
  if (!currentUser) { setAuthUI(false); return; }
  setAuthUI(true);
  const container = document.getElementById("projects");
  let projects = JSON.parse(localStorage.getItem(userKey("projects")) || "[]");
  renderDashboard(projects);
  let toShow = filterAndSort(projects);
  container.innerHTML = "";
  if (!toShow.length) {
    container.innerHTML = "<div style='text-align:center;opacity:0.7;padding:40px;'>No projects to display.</div>";
    return;
  }
  toShow.forEach((p, i) => {
    const idx = projects.findIndex(pr => pr.name === p.name && pr.description === p.description);
    let card = document.createElement("div");
    card.className = "project-card";
    // Project actions
    card.innerHTML = `
      <div class="project-actions">
        <button class="btn secondary" style="padding:4px 7px;" title="Edit" onclick="editProject(${idx})"><span class="material-icons" style="font-size:1.2em;">edit</span></button>
        <button class="btn secondary" style="padding:4px 7px;" title="Delete" onclick="deleteProject(${idx})"><span class="material-icons" style="font-size:1.2em;">delete</span></button>
      </div>
      <h4>${p.name}</h4>
      <p style="min-height:24px">${p.description||""}</p>
      <div class="progress-bar-bg">
        <div class="progress-bar" style="width:${percent((p.tasks||[]).filter(t=>t.done).length, (p.tasks||[]).length)}%"></div>
      </div>
      <div style="font-size:0.95em;margin-bottom:3px;opacity:0.8;">
        ${p.tasks?.filter(t=>t.done).length||0} of ${(p.tasks||[]).length||0} tasks complete
      </div>
      <ul class="task-list" id="task-list-${idx}"></ul>
      <div class="add-task-row">
        <input id="taskInput-${idx}" type="text" placeholder="Task name">
        <select id="taskPrio-${idx}" style="min-width:85px;">
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
        <input type="date" id="taskDue-${idx}" style="min-width:120px;">
        <button class="btn" id="addTaskBtn-${idx}" title="Add Task"><span class="material-icons" style="font-size:1.2em;">add_task</span></button>
      </div>
    `;
    container.appendChild(card);
    // Render tasks
    let list = card.querySelector(".task-list");
    (p.tasks||[]).forEach((t, tidx) => {
      let li = document.createElement("li");
      li.className = "task-item" + (t.done ? " task done" : "");
      let due = t.due ? `<span style="font-size:0.9em;color:#888;">${t.due}</span>` : "";
      li.innerHTML = `
        <input type="checkbox" ${t.done ? "checked" : ""} onclick="toggleTask(${idx},${tidx})">
        <span class="task-title">${t.title}</span>
        <span class="task-priority priority-${t.priority||'low'}">${(t.priority||'low').charAt(0).toUpperCase()+ (t.priority||'low').slice(1)}</span>
        ${due}
        <button class="btn secondary" style="padding:2px 7px;margin-left:5px;" title="Edit Task" onclick="editTask(${idx},${tidx})"><span class="material-icons" style="font-size:1.1em;">edit</span></button>
        <button class="btn secondary" style="padding:2px 7px;" title="Delete Task" onclick="deleteTask(${idx},${tidx})"><span class="material-icons" style="font-size:1.1em;">delete</span></button>
      `;
      list.appendChild(li);
    });
    // Add task logic
    setTimeout(() => {
      document.getElementById(`addTaskBtn-${idx}`).onclick = function() {
        let val = document.getElementById(`taskInput-${idx}`).value.trim();
        let prio = document.getElementById(`taskPrio-${idx}`).value;
        let due = document.getElementById(`taskDue-${idx}`).value;
        if (!val) return;
        projects[idx].tasks = projects[idx].tasks||[];
        projects[idx].tasks.push({ title: val, done: false, priority: prio, due: due });
        localStorage.setItem(userKey("projects"), JSON.stringify(projects));
        document.getElementById(`taskInput-${idx}`).value = "";
        document.getElementById(`taskDue-${idx}`).value = "";
        renderProjects();
      };
    }, 0);
  });
}

// ---- Project/Task Operations ----
window.toggleTask = function(pidx, tidx) {
  let projects = JSON.parse(localStorage.getItem(userKey("projects")) || "[]");
  projects[pidx].tasks[tidx].done = !projects[pidx].tasks[tidx].done;
  localStorage.setItem(userKey("projects"), JSON.stringify(projects));
  renderProjects();
};

window.deleteProject = function(idx) {
  if (!confirm("Delete this project?")) return;
  let projects = JSON.parse(localStorage.getItem(userKey("projects")) || "[]");
  projects.splice(idx,1);
  localStorage.setItem(userKey("projects"), JSON.stringify(projects));
  renderProjects();
};

window.editProject = function(idx) {
  editingProjectIndex = idx;
  let projects = JSON.parse(localStorage.getItem(userKey("projects")) || "[]");
  let proj = projects[idx];
  document.getElementById("modalTitle").textContent = "Edit Project";
  document.getElementById("projectName").value = proj.name;
  document.getElementById("projectDescription").value = proj.description;
  document.getElementById("projectModal").style.display = "flex";
};

window.deleteTask = function(pidx, tidx) {
  let projects = JSON.parse(localStorage.getItem(userKey("projects")) || "[]");
  projects[pidx].tasks.splice(tidx,1);
  localStorage.setItem(userKey("projects"), JSON.stringify(projects));
  renderProjects();
};

window.editTask = function(pidx, tidx) {
  let projects = JSON.parse(localStorage.getItem(userKey("projects")) || "[]");
  let task = projects[pidx].tasks[tidx];
  editingTask = { pidx, tidx };
  document.getElementById("editTaskName").value = task.title;
  document.getElementById("editTaskPriority").value = task.priority||'low';
  document.getElementById("editTaskDueDate").value = task.due||"";
  document.getElementById("taskEditModal").style.display = "flex";
};

// ---- Modal Logic ----
document.getElementById("newProjectBtn").onclick = function() {
  editingProjectIndex = null;
  document.getElementById("modalTitle").textContent = "New Project";
  document.getElementById("projectName").value = "";
  document.getElementById("projectDescription").value = "";
  document.getElementById("projectModal").style.display = "flex";
};
document.getElementById("closeProjectModal").onclick = function() {
  document.getElementById("projectModal").style.display = "none";
};

document.getElementById("saveProjectBtn").onclick = function() {
  let name = document.getElementById("projectName").value.trim();
  let desc = document.getElementById("projectDescription").value.trim();
  if (!name) return alert("Project name required");
  let projects = JSON.parse(localStorage.getItem(userKey("projects")) || "[]");
  if (editingProjectIndex !== null) {
    projects[editingProjectIndex].name = name;
    projects[editingProjectIndex].description = desc;
  } else {
    projects.push({ name, description: desc, tasks: [] });
  }
  localStorage.setItem(userKey("projects"), JSON.stringify(projects));
  document.getElementById("projectModal").style.display = "none";
  renderProjects();
};

document.getElementById("closeTaskEditModal").onclick = function() {
  document.getElementById("taskEditModal").style.display = "none";
};
document.getElementById("saveTaskEditBtn").onclick = function() {
  let title = document.getElementById("editTaskName").value.trim();
  let prio = document.getElementById("editTaskPriority").value;
  let due = document.getElementById("editTaskDueDate").value;
  if (!title) return;
  let projects = JSON.parse(localStorage.getItem(userKey("projects")) || "[]");
  let t = projects[editingTask.pidx].tasks[editingTask.tidx];
  t.title = title; t.priority = prio; t.due = due;
  localStorage.setItem(userKey("projects"), JSON.stringify(projects));
  document.getElementById("taskEditModal").style.display = "none";
  renderProjects();
};

// ---- Auth ----
document.getElementById("loginBtn").onclick = function() {
  let user = prompt("Enter username:");
  if (!user) return;
  currentUser = user;
  localStorage.setItem("user", user);
  renderProjects();
};
document.getElementById("logoutBtn").onclick = function() {
  localStorage.removeItem("user");
  currentUser = null;
  setAuthUI(false);
  document.getElementById("projects").innerHTML = "";
};

// ---- Search, Sort ----
document.getElementById("searchInput").oninput = renderProjects;
document.getElementById("sortProjects").onchange = renderProjects;

// ---- Dark mode ----
document.getElementById("themeBtn").onclick = function() {
  let isDark = document.body.getAttribute("data-theme") === "dark";
  document.body.setAttribute("data-theme", isDark ? "light" : "dark");
  localStorage.setItem("theme", isDark ? "light" : "dark");
};

// ---- Export (XLSX & CSV) ----
document.getElementById("exportBtn").onclick = function() {
  let projects = JSON.parse(localStorage.getItem(userKey("projects")) || "[]");
  // Flatten for export
  let flat = [];
  projects.forEach(p => {
    if ((p.tasks||[]).length) {
      p.tasks.forEach(t => flat.push({
        Project: p.name, Description: p.description, Task: t.title,
        Priority: t.priority||"low", Done: t.done ? "Yes" : "No", Due: t.due||""
      }));
    } else {
      flat.push({ Project: p.name, Description: p.description, Task: "", Priority: "", Done: "", Due: "" });
    }
  });
  // XLSX
  let ws = XLSX.utils.json_to_sheet(flat);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Projects");
  XLSX.writeFile(wb, "project_data.xlsx");
  // CSV
  let csv = Papa.unparse(flat);
  let blob = new Blob([csv], { type: "text/csv" });
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "project_data.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
};

// ---- Import (XLSX & CSV) ----
document.getElementById("importBtn").onclick = function() {
  document.getElementById("fileInput").click();
};
document.getElementById("fileInput").onchange = function(e) {
  let file = e.target.files[0];
  if (!file) return;
  let ext = file.name.split('.').pop().toLowerCase();
  let processRows = rows => {
    let grouped = {};
    rows.forEach(r => {
      if (!r.Project) return;
      if (!grouped[r.Project]) grouped[r.Project] = { name: r.Project, description: r.Description, tasks: [] };
      if (r.Task) grouped[r.Project].tasks.push({
        title: r.Task, priority: r.Priority||"low", done: r.Done === "Yes", due: r.Due||""
      });
    });
    localStorage.setItem(userKey("projects"), JSON.stringify(Object.values(grouped)));
    renderProjects();
  };
  if (ext === "csv") {
    Papa.parse(file, {
      header: true,
      complete: function(results) { processRows(results.data); }
    });
  } else {
    let reader = new FileReader();
    reader.onload = function(ev) {
      let data = new Uint8Array(ev.target.result);
      let wb = XLSX.read(data, { type: "array" });
      let ws = wb.Sheets[wb.SheetNames[0]];
      let rows = XLSX.utils.sheet_to_json(ws);
      processRows(rows);
    };
    reader.readAsArrayBuffer(file);
  }
};

// ---- Theme preference ----
if (localStorage.getItem("theme") === "dark") document.body.setAttribute("data-theme", "dark");

// ---- Initial ----
if (currentUser) renderProjects();
else setAuthUI(false);
</script>
</body>
</html>
